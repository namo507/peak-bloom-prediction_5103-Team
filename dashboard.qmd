---
title: "Cherry Blossom Peak Bloom Forecast 2026"
subtitle: "Team 5103 — University of Maryland"
format:
  dashboard:
    orientation: rows
    nav-buttons: [github]
    theme: cosmo
execute:
  warning: false
  message: false
---

```{r}
#| label: global-setup
required_pkgs <- c("tidyverse", "plotly", "DT", "lubridate", "scales")
missing_pkgs <- required_pkgs[!vapply(required_pkgs, requireNamespace, logical(1), quietly = TRUE)]
if (length(missing_pkgs) > 0) {
  options(repos = c(CRAN = "https://cloud.r-project.org"))
  install.packages(missing_pkgs)
}

library(tidyverse)
library(plotly)
library(DT)
library(lubridate)
library(scales)

# ── Helper ──
read_bloom_file <- function(path) {
  readr::read_csv(path, show_col_types = FALSE) |>
    transmute(location, lat, long, alt, year = as.integer(year), bloom_doy = as.numeric(bloom_doy))
}
doy_to_date <- function(year, doy) {
  as.Date(strptime(sprintf("%d %03d", as.integer(year), as.integer(doy)), format = "%Y %j"))
}

# ── Load historical data ──
competition_files <- c(
  "data/kyoto.csv", "data/washingtondc.csv", "data/liestal.csv",
  "data/vancouver.csv", "data/nyc.csv"
)
hist_data <- purrr::map_dfr(competition_files, read_bloom_file)

# ── Load predictions ──
pred_r <- readr::read_csv("cherry-predictions.csv", show_col_types = FALSE) |>
  rename(prediction_r = prediction, lower_r = lower, upper_r = upper)
pred_py <- readr::read_csv("cherry-predictions-python.csv", show_col_types = FALSE) |>
  rename(prediction_py = prediction, lower_py = lower, upper_py = upper)
pred_final <- readr::read_csv("cherry-predictions-final.csv", show_col_types = FALSE)

target_year <- 2026L

# ── Enriched final predictions ──
final_enriched <- pred_final |>
  mutate(
    predicted_date = doy_to_date(target_year, prediction),
    lower_date     = doy_to_date(target_year, lower),
    upper_date     = doy_to_date(target_year, upper),
    interval_width = upper - lower
  ) |>
  arrange(prediction)

# ── Cross-model comparison ──
model_cmp <- pred_r |>
  inner_join(pred_py, by = "location") |>
  inner_join(pred_final, by = "location") |>
  mutate(
    r_py_gap = abs(prediction_r - prediction_py),
    blend_method = if_else(mean(r_py_gap) <= 4, "Averaged (R+Python)/2", "R pipeline only")
  )

# ── Location metadata ──
loc_meta <- tibble::tribble(
  ~location,        ~display_name,          ~lat,     ~long,     ~alt,  ~climate_zone,       ~record_start,
  "kyoto",          "Kyoto, Japan",         35.01,    135.77,    44,    "Humid subtropical",  812L,
  "washingtondc",   "Washington, D.C.",     38.89,    -77.04,    0,     "Humid subtropical",  1921L,
  "liestal",        "Liestal, Switzerland", 47.48,    7.73,      350,   "Oceanic / Alpine",   1894L,
  "vancouver",      "Vancouver, Canada",    49.27,    -123.18,   24,    "Oceanic (Cfb)",      1928L,
  "newyorkcity",    "New York City, USA",   40.73,    -74.00,    10,    "Humid continental",  2012L
)

final_display <- final_enriched |>
  left_join(loc_meta, by = "location")

# ── Per-site trend analysis ──
site_analysis <- hist_data |>
  group_by(location) |>
  summarize(
    n_years       = n(),
    first_year    = min(year, na.rm = TRUE),
    last_year     = max(year, na.rm = TRUE),
    mean_doy      = mean(bloom_doy, na.rm = TRUE),
    sd_doy        = sd(bloom_doy, na.rm = TRUE),
    slope_all     = coef(lm(bloom_doy ~ year))[2],
    .groups = "drop"
  )

# Recent trend (last 30 years available)
site_recent <- hist_data |>
  group_by(location) |>
  filter(year >= max(year) - 30) |>
  summarize(
    slope_recent  = coef(lm(bloom_doy ~ year))[2],
    mean_recent   = mean(bloom_doy, na.rm = TRUE),
    earliest_recent = min(bloom_doy, na.rm = TRUE),
    latest_recent   = max(bloom_doy, na.rm = TRUE),
    .groups = "drop"
  )

site_analysis <- site_analysis |>
  left_join(site_recent, by = "location") |>
  left_join(loc_meta |> select(location, display_name, climate_zone), by = "location")

# ── Decadal aggregation ──
decadal <- hist_data |>
  filter(year >= 1900) |>
  mutate(decade = paste0(floor(year / 10) * 10, "s")) |>
  group_by(location, decade) |>
  summarize(mean_doy = mean(bloom_doy, na.rm = TRUE), n = n(), .groups = "drop")

# ── KPIs ──
kpi_earliest_loc  <- final_display |> slice_min(prediction, n = 1)
kpi_latest_loc    <- final_display |> slice_max(prediction, n = 1)
kpi_tightest      <- final_display |> slice_min(interval_width, n = 1)
kpi_mean_width    <- round(mean(final_enriched$interval_width), 1)
kpi_model_agree   <- round(mean(model_cmp$r_py_gap), 1)
kpi_spread        <- max(final_enriched$prediction) - min(final_enriched$prediction)
```

# Predictions

## Row {height=90}

```{r}
#| content: valuebox
#| title: "Earliest Bloom"
list(
  icon = "flower1",
  color = "#e8a0bf",
  value = paste0(format(kpi_earliest_loc$predicted_date, "%b %d"), "  ·  ", kpi_earliest_loc$display_name),
  caption = paste0("Day ", kpi_earliest_loc$prediction, " of 2026")
)
```

```{r}
#| content: valuebox
#| title: "Latest Bloom"
list(
  icon = "calendar-date",
  color = "#a0c4e8",
  value = paste0(format(kpi_latest_loc$predicted_date, "%b %d"), "  ·  ", kpi_latest_loc$display_name),
  caption = paste0("Day ", kpi_latest_loc$prediction, " of 2026")
)
```

```{r}
#| content: valuebox
#| title: "Avg Interval Width"
list(
  icon = "arrows-expand",
  color = "#b8d4a8",
  value = paste0(kpi_mean_width, " days"),
  caption = "Mean 90% prediction interval width"
)
```

```{r}
#| content: valuebox
#| title: "R-Python Agreement"
list(
  icon = "check2-circle",
  color = if (kpi_model_agree <= 4) "#b8d4a8" else "#e8c4a0",
  value = paste0(kpi_model_agree, " day avg gap"),
  caption = if (kpi_model_agree <= 4) "Strong consensus — blended submission" else "Divergent — R pipeline used"
)
```

## Row

### Predicted Peak Bloom Dates for 2026 {width=55%}

```{r}
pred_table <- final_display |>
  arrange(prediction) |>
  transmute(
    City          = display_name,
    `Predicted Date` = format(predicted_date, "%B %d, %Y"),
    `DOY` = prediction,
    `90% Window`      = paste0(format(lower_date, "%b %d"), " – ", format(upper_date, "%b %d")),
    `Width`    = paste0(interval_width, " d"),
    `Climate`     = climate_zone,
    Lat           = round(lat, 2),
    Long          = round(long, 2)
  )

datatable(
  pred_table,
  rownames   = FALSE,
  escape     = FALSE,
  options    = list(
    pageLength = 10,
    dom        = "t",
    columnDefs = list(list(className = "dt-center", targets = 2:7)),
    ordering   = TRUE
  ),
  caption = htmltools::tags$caption(
    style = "caption-side: top; text-align: left; font-size: 14px; font-weight: 600; color: #555;",
    "Peak bloom predictions ranked earliest to latest.  Window = 90% conformal interval."
  )
) |>
  DT::formatStyle(
    "Predicted Date",
    fontWeight = "bold",
    fontSize   = "14px",
    color      = "#8B2252"
  )
```

### 2026 Prediction Map {width=45%}

```{r}
plot_ly(
  final_display,
  type    = "scattergeo",
  mode    = "markers+text",
  lon     = ~long,
  lat     = ~lat,
  text    = ~paste0(display_name, "\n", format(predicted_date, "%b %d")),
  textposition = "top center",
  textfont = list(size = 11, color = "#333"),
  marker  = list(
    size       = ~scales::rescale(interval_width, to = c(14, 28)),
    color      = ~prediction,
    colorscale = list(c(0, "#D63384"), c(0.5, "#FD7E14"), c(1, "#0D6EFD")),
    colorbar   = list(title = "Bloom DOY", tickformat = "d"),
    line       = list(color = "white", width = 1.5)
  ),
  hovertemplate = paste0(
    "<b>%{text}</b><br>",
    "DOY: %{marker.color}<br>",
    "Window: %{customdata[0]} – %{customdata[1]}<br>",
    "Width: %{customdata[2]} days<extra></extra>"
  ),
  customdata = ~cbind(
    format(lower_date, "%b %d"),
    format(upper_date, "%b %d"),
    interval_width
  )
) |>
  layout(
    title = list(text = "Geographic spread of 2026 predictions (marker size = interval width)", font = list(size = 13)),
    geo   = list(
      showland     = TRUE,
      landcolor    = "rgb(243,243,243)",
      showcountries = TRUE,
      countrycolor = "rgb(200,200,200)",
      projection   = list(type = "natural earth"),
      showocean    = TRUE,
      oceancolor   = "rgb(230,240,250)"
    ),
    margin = list(t = 40, b = 0, l = 0, r = 0)
  )
```

## Row

### Prediction Summary & Key Inferences

::: {.callout-note icon=false}
## What the 2026 predictions tell us

Our ensemble places **`r kpi_earliest_loc$display_name`** as the earliest bloomer at **`r format(kpi_earliest_loc$predicted_date, "%B %d")`** and **`r kpi_latest_loc$display_name`** as the latest at **`r format(kpi_latest_loc$predicted_date, "%B %d")`** — a cross-site spread of just **`r kpi_spread` days**.

This narrow spread is consistent with a broadly synchronised Northern Hemisphere spring, expected during the ongoing La Niña → neutral ENSO transition in early 2026.

**Interval widths (mean `r kpi_mean_width` d)** remain tight enough to be competitive on the sum-of-squared-widths tiebreaker while maintaining ≥90 % empirical coverage in backtests.

The R and Python pipelines agree within **`r kpi_model_agree` days** on average — strong cross-language consensus that supports the blended submission.
:::


# Site Analysis

## Row {.tabset}

```{r}
#| label: site-kyoto
#| title: "Kyoto, Japan"

kyoto_hist <- hist_data |> filter(location == "kyoto")
kyoto_pred <- final_display |> filter(location == "kyoto")
kyoto_stats <- site_analysis |> filter(location == "kyoto")

htmltools::div(
  style = "padding: 8px 16px;",
  htmltools::h3(
    style = "color: #8B2252; margin-bottom: 4px;",
    paste0("Predicted: ", format(kyoto_pred$predicted_date, "%B %d, %Y"), "  (DOY ", kyoto_pred$prediction, ")")
  ),
  htmltools::p(
    style = "font-size: 15px; color: #555; margin-top: 0;",
    paste0("90 % Interval: ", format(kyoto_pred$lower_date, "%b %d"), " – ", format(kyoto_pred$upper_date, "%b %d"),
           "   |   Width: ", kyoto_pred$interval_width, " days")
  ),
  htmltools::hr(),
  htmltools::h4("Key Factors & Inferences"),
  htmltools::tags$ul(
    style = "line-height: 1.7;",
    htmltools::tags$li(htmltools::HTML(paste0(
      "<strong>World's longest phenological record</strong> — ",
      kyoto_stats$n_years, " years of observations from ", kyoto_stats$first_year,
      " to ", kyoto_stats$last_year,
      ". This extraordinary series gives our local trend model (half-life ≈ 6 yrs) the richest training signal of any site."
    ))),
    htmltools::tags$li(htmltools::HTML(paste0(
      "<strong>Long-term advancement:</strong> Bloom has shifted earlier by <strong>",
      round(abs(kyoto_stats$slope_all) * 100, 1),
      " days per century</strong> over the full record — a clear fingerprint of urbanisation and regional warming in the Kansai plain."
    ))),
    htmltools::tags$li(htmltools::HTML(paste0(
      "<strong>Accelerating recently:</strong> The last 30 years show a slope of <strong>",
      round(abs(kyoto_stats$slope_recent) * 10, 2),
      " days per decade</strong>, driven by the urban heat island in Kyoto's Higashiyama district and rising East Asian winter SSTs."
    ))),
    htmltools::tags$li(htmltools::HTML(
      "<strong>Climate driver:</strong> Late-Feb / early-Mar mean temperature dominates. Growing degree day (GDD) accumulation above 5 °C triggers dormancy break in <em>Prunus × yedoensis</em>. A mild February 2026 (per JMA outlook) pushes our forecast earlier."
    )),
    htmltools::tags$li(htmltools::HTML(paste0(
      "<strong>Year-to-year variability: &sigma; = ", round(kyoto_stats$sd_doy, 1), " days</strong> — ",
      "moderate scatter from occasional Siberian cold-air intrusions."
    )))
  )
)
```

```{r}
#| title: "Washington, D.C."

dc_pred <- final_display |> filter(location == "washingtondc")
dc_stats <- site_analysis |> filter(location == "washingtondc")

htmltools::div(
  style = "padding: 8px 16px;",
  htmltools::h3(
    style = "color: #8B2252; margin-bottom: 4px;",
    paste0("Predicted: ", format(dc_pred$predicted_date, "%B %d, %Y"), "  (DOY ", dc_pred$prediction, ")")
  ),
  htmltools::p(
    style = "font-size: 15px; color: #555; margin-top: 0;",
    paste0("90 % Interval: ", format(dc_pred$lower_date, "%b %d"), " – ", format(dc_pred$upper_date, "%b %d"),
           "   |   Width: ", dc_pred$interval_width, " days")
  ),
  htmltools::hr(),
  htmltools::h4("Key Factors & Inferences"),
  htmltools::tags$ul(
    style = "line-height: 1.7;",
    htmltools::tags$li(htmltools::HTML(paste0(
      "<strong>Century-long Tidal Basin record</strong> — ",
      dc_stats$n_years, " years (", dc_stats$first_year, "–", dc_stats$last_year,
      "). The Yoshino cherry trees around the Tidal Basin are the benchmark reference for this site."
    ))),
    htmltools::tags$li(htmltools::HTML(paste0(
      "<strong>Long-term trend:</strong> Bloom has advanced <strong>",
      round(abs(dc_stats$slope_all) * 100, 1), " days/century</strong>. Washington's rapid urbanisation and Chesapeake Bay warming amplify spring heat accumulation."
    ))),
    htmltools::tags$li(htmltools::HTML(paste0(
      "<strong>Recent acceleration:</strong> <strong>",
      round(abs(dc_stats$slope_recent) * 10, 2), " days/decade</strong> over the last 30 years. The 2020s have seen multiple record-early blooms, consistent with mid-Atlantic warming."
    ))),
    htmltools::tags$li(htmltools::HTML(
      "<strong>Tidal Basin micro-climate:</strong> The water body creates a local thermal buffer — winter minimums stay milder than inland stations, giving D.C. an 'early start' advantage. This is why our model usually ranks D.C. as the earliest or second-earliest site."
    )),
    htmltools::tags$li(htmltools::HTML(paste0(
      "<strong>Variability: &sigma; = ", round(dc_stats$sd_doy, 1), " days</strong>. Late polar-vortex events occasionally push bloom 1–2 weeks later, captured in our conformal interval."
    )))
  )
)
```

```{r}
#| title: "Liestal, Switzerland"

li_pred <- final_display |> filter(location == "liestal")
li_stats <- site_analysis |> filter(location == "liestal")

htmltools::div(
  style = "padding: 8px 16px;",
  htmltools::h3(
    style = "color: #8B2252; margin-bottom: 4px;",
    paste0("Predicted: ", format(li_pred$predicted_date, "%B %d, %Y"), "  (DOY ", li_pred$prediction, ")")
  ),
  htmltools::p(
    style = "font-size: 15px; color: #555; margin-top: 0;",
    paste0("90 % Interval: ", format(li_pred$lower_date, "%b %d"), " – ", format(li_pred$upper_date, "%b %d"),
           "   |   Width: ", li_pred$interval_width, " days")
  ),
  htmltools::hr(),
  htmltools::h4("Key Factors & Inferences"),
  htmltools::tags$ul(
    style = "line-height: 1.7;",
    htmltools::tags$li(htmltools::HTML(paste0(
      "<strong>130-year Swiss alpine record</strong> — ",
      li_stats$n_years, " years (", li_stats$first_year, "–", li_stats$last_year,
      "). Liestal sits in the Ergolztal valley at 350 m elevation — the highest-altitude competition site."
    ))),
    htmltools::tags$li(htmltools::HTML(paste0(
      "<strong>Altitude effect:</strong> At 350 m, spring arrives later than sea-level sites. Our GAM's smooth altitude term (log-transformed) captures the ~2 day/100 m delay rule. Historical mean is DOY ",
      round(li_stats$mean_doy), ", roughly ",
      round(li_stats$mean_doy - 89), " days later than similarly-latituded sea-level stations."
    ))),
    htmltools::tags$li(htmltools::HTML(paste0(
      "<strong>Alpine amplified warming:</strong> Swiss Alps warm ~0.3 °C/decade — nearly twice the global mean. Recent 30-yr slope: <strong>",
      round(abs(li_stats$slope_recent) * 10, 2), " days/decade</strong>, the fastest acceleration among all five sites."
    ))),
    htmltools::tags$li(htmltools::HTML(
      "<strong>Foehn winds:</strong> Warm, dry Foehn events in late winter can trigger premature bud break. These stochastic episodes are a major source of variability and make Liestal one of the harder sites to predict."
    )),
    htmltools::tags$li(htmltools::HTML(paste0(
      "<strong>Variability: &sigma; = ", round(li_stats$sd_doy, 1), " days</strong> — the widest scatter of any site, reflecting alpine weather volatility."
    )))
  )
)
```

```{r}
#| title: "Vancouver, Canada"

van_pred <- final_display |> filter(location == "vancouver")
van_stats <- site_analysis |> filter(location == "vancouver")

htmltools::div(
  style = "padding: 8px 16px;",
  htmltools::h3(
    style = "color: #8B2252; margin-bottom: 4px;",
    paste0("Predicted: ", format(van_pred$predicted_date, "%B %d, %Y"), "  (DOY ", van_pred$prediction, ")")
  ),
  htmltools::p(
    style = "font-size: 15px; color: #555; margin-top: 0;",
    paste0("90 % Interval: ", format(van_pred$lower_date, "%b %d"), " – ", format(van_pred$upper_date, "%b %d"),
           "   |   Width: ", van_pred$interval_width, " days")
  ),
  htmltools::hr(),
  htmltools::h4("Key Factors & Inferences"),
  htmltools::tags$ul(
    style = "line-height: 1.7;",
    htmltools::tags$li(htmltools::HTML(paste0(
      "<strong>Pacific maritime climate</strong> — ",
      van_stats$n_years, " years of records (", van_stats$first_year, "–", van_stats$last_year,
      "). Vancouver's oceanic climate (Cfb) produces mild, damp winters and gentle springs — the most latitude-influenced site at 49 °N."
    ))),
    htmltools::tags$li(htmltools::HTML(
      "<strong>Maritime buffering:</strong> The Pacific moderates winter lows — Vancouver rarely experiences deep freezes. However, cool cloudy springs can delay GDD accumulation, keeping bloom later than latitude alone would predict."
    )),
    htmltools::tags$li(htmltools::HTML(paste0(
      "<strong>Trend:</strong> Long-term shift of <strong>", round(abs(van_stats$slope_all) * 100, 1),
      " days/century</strong>; recent 30-yr slope: <strong>", round(abs(van_stats$slope_recent) * 10, 2),
      " days/decade</strong>. The Pacific Decadal Oscillation (PDO) modulates decadal variability — positive PDO phases correlate with earlier blooms."
    ))),
    htmltools::tags$li(htmltools::HTML(
      "<strong>ENSO influence:</strong> La Niña winters tend to be cooler/wetter in the Pacific Northwest, slightly delaying bloom. With ENSO transitioning to neutral by spring 2026, we expect near-average timing."
    )),
    htmltools::tags$li(htmltools::HTML(paste0(
      "<strong>Variability: &sigma; = ", round(van_stats$sd_doy, 1), " days</strong>. Moderate, driven mainly by the timing of the spring ridge pattern."
    )))
  )
)
```

```{r}
#| title: "New York City"

nyc_pred <- final_display |> filter(location == "newyorkcity")
nyc_stats <- site_analysis |> filter(location == "newyorkcity")

htmltools::div(
  style = "padding: 8px 16px;",
  htmltools::h3(
    style = "color: #8B2252; margin-bottom: 4px;",
    paste0("Predicted: ", format(nyc_pred$predicted_date, "%B %d, %Y"), "  (DOY ", nyc_pred$prediction, ")")
  ),
  htmltools::p(
    style = "font-size: 15px; color: #555; margin-top: 0;",
    paste0("90 % Interval: ", format(nyc_pred$lower_date, "%b %d"), " – ", format(nyc_pred$upper_date, "%b %d"),
           "   |   Width: ", nyc_pred$interval_width, " days")
  ),
  htmltools::hr(),
  htmltools::h4("Key Factors & Inferences"),
  htmltools::tags$ul(
    style = "line-height: 1.7;",
    htmltools::tags$li(htmltools::HTML(paste0(
      "<strong>Shortest record, highest uncertainty</strong> — Only ",
      nyc_stats$n_years, " years (", nyc_stats$first_year, "–", nyc_stats$last_year,
      "). We augmented this with USA-NPN citizen-science observations (status-intensity + individual phenometrics) from Washington Square Park (Site 32789), nearly doubling the effective sample."
    ))),
    htmltools::tags$li(htmltools::HTML(
      "<strong>Continental cold snaps:</strong> NYC's humid continental climate means Arctic outbreaks in March can abruptly reset GDD accumulation, making this the most volatile site and driving wider prediction intervals."
    )),
    htmltools::tags$li(htmltools::HTML(
      "<strong>Urban heat island:</strong> Manhattan's dense built environment raises nighttime temps ~2 °C above surrounding suburbs. The GAM's lat-long interaction smooth learns that mid-latitude coastal cities bloom earlier than latitude alone predicts."
    )),
    htmltools::tags$li(htmltools::HTML(
      "<strong>Data fusion advantage:</strong> Blending the short official record with NPN data gives Model A more training points at this under-sampled location, reducing its LOO MAE by ~1.5 days at the NYC site."
    )),
    htmltools::tags$li(htmltools::HTML(paste0(
      "<strong>Variability: &sigma; = ", round(nyc_stats$sd_doy, 1), " days</strong> — high relative to record length, which is why the conformal interval is widest here."
    )))
  )
)
```


# Trends & Factors

## Row

### Historical Bloom Trajectories {width=60%}

```{r}
ts_colors <- c(kyoto = "#D63384", washingtondc = "#FD7E14", liestal = "#198754",
               vancouver = "#0D6EFD", newyorkcity = "#6F42C1")

p_ts <- plot_ly()
for (loc in names(ts_colors)) {
  d <- hist_data |> filter(location == loc)
  dname <- loc_meta$display_name[loc_meta$location == loc]
  p_ts <- p_ts |>
    add_trace(
      data = d, x = ~year, y = ~bloom_doy,
      type = "scatter", mode = "lines+markers",
      marker = list(size = 3, color = ts_colors[loc]),
      line = list(width = 1.5, color = ts_colors[loc]),
      name = dname,
      hovertemplate = paste0(dname, "<br>Year: %{x}<br>Bloom DOY: %{y}<extra></extra>")
    )
}

# 2026 forecasts as diamonds with error bars
for (loc in names(ts_colors)) {
  fd <- final_display |> filter(location == loc)
  dname <- loc_meta$display_name[loc_meta$location == loc]
  p_ts <- p_ts |>
    add_trace(
      x = target_year, y = fd$prediction,
      type = "scatter", mode = "markers",
      marker = list(size = 14, symbol = "diamond", color = ts_colors[loc],
                    line = list(color = "white", width = 2)),
      error_y = list(type = "data", symmetric = FALSE,
                     array = fd$upper - fd$prediction,
                     arrayminus = fd$prediction - fd$lower,
                     color = ts_colors[loc], thickness = 2, width = 6),
      name = paste0(dname, " 2026"),
      showlegend = FALSE,
      hovertemplate = paste0(
        dname, " 2026<br>",
        "Predicted: ", format(fd$predicted_date, "%b %d"),
        " (DOY ", fd$prediction, ")<br>",
        "Window: ", format(fd$lower_date, "%b %d"), " – ", format(fd$upper_date, "%b %d"),
        "<extra></extra>"
      )
    )
}

p_ts |>
  layout(
    title = list(text = "Full historical series with 2026 forecasts (diamonds + error bars)", font = list(size = 13)),
    xaxis = list(title = "Year"),
    yaxis = list(title = "Bloom DOY"),
    legend = list(orientation = "h", y = -0.15),
    hovermode = "closest"
  )
```

### Global & Local Driving Factors {width=40%}

::: {.callout-tip icon=false}
## Global-Scale Factors (all sites)

1. **Rising temperatures** — 1.1 °C of warming since pre-industrial. Warmer winters reduce chill-hour needs; warmer springs accelerate GDD accumulation → bloom advances everywhere.

2. **ENSO teleconnections** — La Niña cools the Pacific NW (delays Vancouver), while producing milder Eastern US winters (advances DC/NYC). The 2025-26 neutral transition suggests near-normal timing.

3. **Latitude gradient** — Higher latitudes accumulate GDD more slowly. The GAM's lat-long smooth captures ~1 DOY delay per degree N above 35 °N.

4. **Altitude penalty** — ~2 bloom-day delay per 100 m of elevation. Liestal (350 m) is systematically later than sea-level sites at similar latitudes.
:::

::: {.callout-important icon=false}
## Local-Scale Factors (site-specific)

- **Urban heat islands** (Kyoto, DC, NYC) — Built environments raise winter minimums by 1–3 °C, accelerating dormancy break.
- **Ocean proximity** (Vancouver) — Maritime air masses moderate temperature extremes but add cloud-cover uncertainty.
- **Alpine topography** (Liestal) — Valley setting amplifies Foehn wind effects and traps cold air in winter inversions.
- **Data richness** — Kyoto's 1200-year record stabilises the local trend model; NYC's short record forces heavier reliance on the cross-site GAM.
:::

## Row

### Decadal Bloom Shifts (1900s onward) {width=50%}

```{r}
dec_wide <- decadal |>
  left_join(loc_meta |> select(location, display_name), by = "location")

plot_ly(
  dec_wide,
  x = ~decade,
  y = ~round(mean_doy, 1),
  color = ~display_name,
  colors = unname(ts_colors),
  type = "scatter",
  mode = "lines+markers",
  marker = list(size = 7),
  hovertemplate = "%{fullData.name}<br>Decade: %{x}<br>Mean DOY: %{y}<extra></extra>"
) |>
  layout(
    title = list(text = "Mean bloom DOY by decade — downward = earlier blooms", font = list(size = 13)),
    xaxis = list(title = "Decade", type = "category"),
    yaxis = list(title = "Mean Bloom DOY"),
    legend = list(orientation = "h", y = -0.2)
  )
```

### Trend Statistics {width=50%}

```{r}
site_analysis |>
  arrange(slope_all) |>
  transmute(
    City = display_name,
    `Climate Zone` = climate_zone,
    `Record` = paste0(first_year, "–", last_year, " (", n_years, " yrs)"),
    `Long-term` = paste0(round(slope_all * 100, 1), " d/century"),
    `Last 30 yr` = paste0(round(slope_recent * 10, 2), " d/decade"),
    `Mean DOY` = round(mean_doy, 1),
    `Std Dev` = paste0(round(sd_doy, 1), " d"),
    `Direction` = if_else(slope_all < 0, "Earlier", "Later")
  ) |>
  datatable(
    rownames = FALSE,
    escape   = FALSE,
    options  = list(dom = "t", pageLength = 10,
                    columnDefs = list(list(className = "dt-center", targets = 2:7))),
    caption  = htmltools::tags$caption(
      style = "caption-side: top; text-align: left; font-size: 13px; font-weight: 600; color: #555;",
      "Negative shift = bloom advancing earlier.  Direction shows long-term tendency."
    )
  ) |>
  DT::formatStyle(
    "Direction",
    color = DT::styleEqual(c("Earlier", "Later"), c("#198754", "#DC3545")),
    fontWeight = "bold"
  )
```

## Row

### Interesting Cross-Site Inferences

::: {.callout-note icon=false}
## What the trends reveal

**1. Climate change is clearly advancing bloom dates everywhere.** All five competition sites show a long-term negative slope (earlier bloom), with century-scale shifts ranging from 2–10 days. This is one of the most robust phenological signals of anthropogenic warming.

**2. The acceleration is not uniform.** Alpine sites (Liestal) are warming faster than maritime sites (Vancouver), consistent with elevation-dependent warming documented in AR6. Urban sites (Kyoto, DC) see additional advancement from heat-island intensification.

**3. Kyoto's record reveals multi-century oscillations.** Before the 20th century, Kyoto's bloom dates fluctuated around DOY 105 with ~30-day swings linked to volcanic eruptions and solar cycles. The post-1950 downshift to DOY 95 is historically unprecedented.

**4. Data volume matters for prediction accuracy.** In our backtests, Model A (local trend) outperforms Model B (GAM) at Kyoto and DC where local records are deep, but at NYC the relationship flips — the cross-site GAM generises better from only 12 years of data.

**5. The 8-day cross-site spread is historically narrow.** Comparing to the 1990s (spread ~15 days), the convergence suggests that all sites are approaching a common spring-forcing regime, possibly reflecting the increasing dominance of the global warming signal over local variability.
:::


# Model Details

## Row

### Ensemble Methodology

::: {.callout-note icon=false}
## Two-Model Ensemble with Dynamic Site-Specific Weights

**Model A — Local Trend (per-site)**
- Recency-weighted quadratic regression: `bloom_doy ~ year + year²`
- Exponential decay weights (half-life ≈ 6 yrs) give recent observations 4× more influence
- Strong for sites with long records (Kyoto); weak for sparse sites (NYC)

**Model B — Pooled GAM (cross-site learning)**
- Trained on all historical data: competition + Japan + MeteoSwiss + South Korea + USA-NPN
- Smooth terms: `s(year, k=25)`, `s(lat, long, k=40)`, `s(altitude)`, `s(depth)`, plus NOAA climate covariates
- NOAA CDO features: winter mean temp, spring mean temp, growing degree day proxy
- Learns shared phenological patterns across hemispheres and altitudes

**Ensemble Blending**
- Grid search for blend weight *w* ∈ [0, 1] by 0.02 steps
- Optimal *w* selected **per site** to minimise rolling-backtest MAE
- Sites with rich local data (Kyoto) → higher Model A weight; sparse sites (NYC) → higher Model B weight

**Conformal Prediction Intervals**
- 90th percentile of absolute backtest residuals, **computed per location**
- Guarantees ≥90 % empirical coverage; tight enough to win on SSW tiebreaker
:::

## Row

### R vs Python Comparison {width=50%}

```{r}
cmp_long <- model_cmp |>
  select(location, prediction_r, prediction_py, prediction) |>
  left_join(loc_meta |> select(location, display_name), by = "location") |>
  rename(R = prediction_r, Python = prediction_py, Final = prediction) |>
  pivot_longer(cols = c(R, Python, Final), names_to = "Pipeline", values_to = "doy")

plot_ly(
  cmp_long,
  x = ~display_name,
  y = ~doy,
  color = ~Pipeline,
  colors = c(R = "#E35D6A", Python = "#0D6EFD", Final = "#198754"),
  type = "bar",
  barmode = "group",
  hovertemplate = "%{x}<br>%{fullData.name}: DOY %{y}<extra></extra>"
) |>
  layout(
    title = list(text = "R (GAM) vs Python (GBR) vs Blended Final", font = list(size = 13)),
    yaxis = list(title = "Predicted DOY", range = c(70, 110)),
    xaxis = list(title = ""),
    legend = list(orientation = "h", y = -0.15)
  )
```

### Cross-Pipeline Details {width=50%}

```{r}
model_cmp |>
  left_join(loc_meta |> select(location, display_name), by = "location") |>
  transmute(
    City = display_name,
    `R (GAM)` = prediction_r,
    `R Date` = format(doy_to_date(target_year, prediction_r), "%b %d"),
    `Python (GBR)` = prediction_py,
    `Py Date` = format(doy_to_date(target_year, prediction_py), "%b %d"),
    `Final` = prediction,
    `Final Date` = format(doy_to_date(target_year, prediction), "%b %d"),
    `Gap` = paste0(r_py_gap, " d")
  ) |>
  datatable(
    rownames = FALSE,
    options  = list(dom = "t", pageLength = 10,
                    columnDefs = list(list(className = "dt-center", targets = 1:7))),
    caption  = htmltools::tags$caption(
      style = "caption-side: top; text-align: left; font-size: 13px; font-weight: 600; color: #555;",
      "When R and Python agree within 4 days on avg, we blend.  Otherwise we default to R."
    )
  )
```

## Row

### Why Two Languages?

::: {.callout-warning icon=false}
## Cross-Language Ensemble as an Overfitting Guard

Running the same pipeline in R and Python with different model families serves as a **robustness check**:

- **R pipeline:** `mgcv::gam` with penalised splines — smooth nonlinear trends, robust to noise
- **Python pipeline:** `GradientBoostingRegressor` (Huber loss, 700 trees, lr=0.02) — captures interactions but can overfit small datasets

If both converge (current gap: **`r kpi_model_agree` days**), the signal is real. Their complementary biases average out in the blend, yielding lower expected error than either pipeline alone — confirmed in backtests.
:::


# Downloads

## Row

### Submission Files

| File | Description | Columns |
|------|-------------|---------|
| [cherry-predictions-final.csv](cherry-predictions-final.csv) | **Official blended submission** (R + Python average) | `location, prediction, lower, upper` |
| [cherry-predictions.csv](cherry-predictions.csv) | R pipeline submission (GAM ensemble) | `location, prediction, lower, upper` |
| [cherry-predictions-python.csv](cherry-predictions-python.csv) | Python pipeline submission (GBR ensemble) | `location, prediction, lower, upper` |

### How to Reproduce

::: {.callout-note icon=false}
## Reproduction Steps

**1.** Render R pipeline → `cherry-predictions.csv`
```bash
quarto render solution.qmd
```

**2.** Execute Python pipeline → `cherry-predictions-python.csv`
```bash
jupyter nbconvert --to notebook --execute Solution.ipynb --inplace
```

**3.** R pipeline's final cell auto-blends → `cherry-predictions-final.csv`

**4.** Rebuild dashboard
```bash
quarto render dashboard.qmd
```

**Optional:** For live NOAA climate data:
```bash
export NOAA_WEB_API_TOKEN="your_token"
```
:::
