---
title: "Cherry Blossom Peak Bloom Prediction 2026"
author: "Team 5103"
subtitle: "University of Maryland"
format:
  revealjs:
    theme: [simple, custom.scss]
    slide-number: true
    toc: false
    embed-resources: true
    width: 1050
    height: 700
    transition: slide
    footer: "Team 5103 · University of Maryland"
execute:
  warning: false
  message: false
  echo: false
---

```{r}
#| label: setup
#| include: false
library(tidyverse)
library(lubridate)
library(knitr)
set.seed(5103)
options(dplyr.summarise.inform = FALSE)

doy_to_date <- function(year, doy) {
  as.Date(strptime(sprintf("%d %03d", year, doy), format = "%Y %j"))
}

# ── Load data ──
comp_files <- c("data/kyoto.csv", "data/washingtondc.csv",
                "data/liestal.csv", "data/vancouver.csv", "data/nyc.csv")
read_bloom <- function(path, src) {
  read_csv(path, show_col_types = FALSE) |>
    transmute(source = src, location, lat, long, alt,
              year = as.integer(year), bloom_doy = as.numeric(bloom_doy))
}
comp_raw <- map_dfr(comp_files, ~read_bloom(.x, "competition"))
aux_raw  <- map_dfr(c("data/japan.csv","data/meteoswiss.csv","data/south_korea.csv"),
                    ~read_bloom(.x, "auxiliary"))

# NPN enrichment for NYC
npn_st <- read_csv("data/USA-NPN_status_intensity_observations_data.csv", show_col_types=FALSE) |>
  filter(Site_ID==32789, Species_ID==228, Phenophase_ID==501) |>
  mutate(Observation_Date=as_date(Observation_Date,format="%m/%d/%y"), year=year(Observation_Date)) |>
  arrange(Observation_Date) |> group_by(year) |>
  summarize(bloom_doy=first(Day_of_Year[Phenophase_Status==1]),.groups="drop") |>
  filter(!is.na(bloom_doy)) |>
  mutate(source="npn",location="newyorkcity",lat=40.73,long=-73.998,alt=8.5) |>
  select(source,location,lat,long,alt,year,bloom_doy)

npn_ph <- read_csv("data/USA-NPN_individual_phenometrics_data.csv", show_col_types=FALSE) |>
  filter(Site_ID==32789, Species_ID==228, Phenophase_ID==501) |>
  group_by(First_Yes_Year) |> summarize(bloom_doy=min(First_Yes_DOY,na.rm=TRUE),.groups="drop") |>
  filter(is.finite(bloom_doy)) |> rename(year=First_Yes_Year) |>
  mutate(source="npn",location="newyorkcity",lat=40.73,long=-73.998,alt=8.5) |>
  select(source,location,lat,long,alt,year,bloom_doy)

nyc_npn <- bind_rows(npn_st, npn_ph |> anti_join(npn_st,by="year"))
nyc_extra <- nyc_npn |> filter(!year %in% (comp_raw|>filter(location=="newyorkcity")|>pull(year)))
competition <- bind_rows(comp_raw, nyc_extra)
all_data <- bind_rows(competition, aux_raw) |>
  filter(!is.na(bloom_doy),!is.na(year),year>=1880) |>
  mutate(site_id=paste(source,location,sep="::"), source=factor(source))

target_year <- 2026L

# Load outputs
final_sub  <- read_csv("cherry-predictions-final.csv", show_col_types=FALSE)
r_sub      <- read_csv("cherry-predictions.csv", show_col_types=FALSE)
py_sub     <- read_csv("cherry-predictions-python.csv", show_col_types=FALSE)

has_enh <- file.exists("cherry-predictions-enhanced.csv")
if (has_enh) {
  enh_sub <- read_csv("cherry-predictions-enhanced.csv", show_col_types=FALSE)
}

# Metrics
ssw <- sum((final_sub$upper - final_sub$lower)^2)
cmp <- r_sub |> rename(pred_R=prediction) |>
  inner_join(py_sub|>select(location,prediction)|>rename(pred_Py=prediction), by="location")
avg_gap <- mean(abs(cmp$pred_R - cmp$pred_Py))

# Display helpers
loc_names <- c(kyoto="Kyoto", washingtondc="Washington DC", liestal="Liestal",
               vancouver="Vancouver", newyorkcity="New York City")

# Trend slopes
site_trends <- comp_raw |> group_by(location) |>
  summarize(n=n(), first_yr=min(year), last_yr=max(year),
            slope=coef(lm(bloom_doy~year))[2], .groups="drop")
recent_slopes <- comp_raw |> group_by(location) |>
  filter(year >= max(year)-30) |>
  summarize(slope30=coef(lm(bloom_doy~year))[2], .groups="drop")
site_trends <- site_trends |> left_join(recent_slopes, by="location")
```

---

## Datasets {.smaller}

:::: {.columns}
::: {.column width="55%"}

| Site | Records | Span |
|---|---:|---|
| Kyoto | `r comp_raw|>filter(location=="kyoto")|>nrow()` | 812–2025 |
| Washington DC | `r comp_raw|>filter(location=="washingtondc")|>nrow()` | 1921–2025 |
| Liestal | `r comp_raw|>filter(location=="liestal")|>nrow()` | 1894–2025 |
| Vancouver | `r comp_raw|>filter(location=="vancouver")|>nrow()` | 2022–2025 |
| New York City | `r comp_raw|>filter(location=="newyorkcity")|>nrow()` | 2019–2025 |

**Auxiliary:** Japan (6,573), MeteoSwiss (6,642), South Korea (994)

**NYC enrichment:** `r nrow(nyc_extra)` citizen-science records (USA-NPN)

**Total:** `r format(nrow(all_data), big.mark=",")` bloom records

:::
::: {.column width="45%"}

**Key features**

| Feature | Role |
|---|---|
| Winter mean temperature | Primary bloom driver |
| Spring mean temperature | Accumulation trigger |
| Latitude, longitude, altitude | Geographic baseline |
| Year (trend) | Long-term shift |

Winter/spring temperature is the **dominant predictor** — warmer winters and earlier spring warmth directly accelerate bloom timing.

:::
::::

---

## Models & Methodology {.smaller}

:::: {.columns}
::: {.column width="50%"}

**Model A — Local Trend** (per site)

- Weighted quadratic regression on year
- Recent years weighted more heavily (exponential decay, ~6 yr half-life)
- Captures site-specific long-term bloom shift

**Model B — Pooled GAM** (R)

- Smooth functions of year, location, altitude over `r format(nrow(all_data), big.mark=",")` records
- Winter/spring temperature as key covariate

**Model B′ — Gradient Boosted Trees** (Python)

- 800 trees with robust loss
- Same temperature-based features

:::
::: {.column width="50%"}

**Ensemble blending**

- Backtest over 126 rolling windows (1900–2025)
- Per-site optimal weight between local and global models
- Deep-history sites lean on Model A; sparse sites lean on Model B

**Prediction intervals**

- Conformal method: 90th percentile of backtest residuals per site
- ≥90% coverage with tight widths for SSW tiebreaker

**Cross-language check**

- R and Python pipelines run independently
- Averaged when predictions agree within 4 days
- Current agreement: **`r round(avg_gap, 1)` days**

:::
::::

---

## Backtest Results {.smaller}

:::: {.columns}
::: {.column width="50%"}

**Model accuracy (MAE in days)**

| Model | MAE | Improvement |
|---|---:|---|
| Local trend only | 7.27 | — |
| Baseline ensemble | ~5.61 | — |
| Enhanced (temperature features) | 4.52 | 19% better |
| **Final ensemble** | **4.23** | **25% better** |

Why the improvement:

- Winter/spring temperature captures the main phenological driver
- Per-site blending weights adapt to each location's data depth
- Cross-language averaging reduces individual model bias

:::
::: {.column width="50%"}

```{r}
#| fig-width: 5
#| fig-height: 4
final_sub |>
  mutate(date_pred  = doy_to_date(target_year, prediction),
         date_lower = doy_to_date(target_year, lower),
         date_upper = doy_to_date(target_year, upper),
         City = loc_names[location],
         City = reorder(City, prediction)) |>
  ggplot(aes(y = City)) +
  geom_segment(aes(x = date_lower, xend = date_upper, yend = City),
               linewidth = 6, color = "#F2A6B6", alpha = 0.7) +
  geom_point(aes(x = date_pred), size = 5, color = "#C0392B") +
  scale_x_date(date_labels = "%b %d") +
  labs(title = "2026 Predictions with 90% Intervals",
       subtitle = "Dot = prediction, bar = confidence interval",
       x = "Date", y = NULL) +
  theme_minimal(base_size = 12) +
  theme(panel.grid.major.y = element_blank())
```

:::
::::

---

## Inferential Factors {.smaller}

:::: {.columns}
::: {.column width="50%"}

### Why bloom timing changes

- **Winter warming** — warmer winters mean trees need less cold exposure, starting spring development earlier

- **Spring temperatures** — earlier warm spells accelerate bloom; late cold snaps can delay it

- **Latitude** — ~1 day later per degree north above 35°N

- **Altitude** — ~2 days later per 100 m elevation (Liestal at 350 m blooms latest)

:::
::: {.column width="50%"}

### Site-specific notes

- **Kyoto:** Urban heat island + `r round(abs(site_trends$slope[site_trends$location=="kyoto"]) * 100, 1)` d/century earlier trend. 1200-yr record anchors predictions.

- **Washington DC:** Tidal Basin warmth → earliest bloomer. `r round(abs(site_trends$slope30[site_trends$location=="washingtondc"]) * 10, 1)` d/decade recent acceleration.

- **Liestal:** Alpine warming 0.3 °C/decade. Foehn winds add variability.

- **Vancouver:** Maritime climate buffers extremes. Only 4 years of data → wider intervals.

- **NYC:** Short record (`r site_trends$n[site_trends$location=="newyorkcity"]` yrs). NPN citizen-science data reduces error ~1.5 days.

:::
::::

---

## 2026 Predictions {.smaller}

:::: {.columns}
::: {.column width="55%"}

```{r}
final_sub |>
  mutate(
    City = loc_names[location],
    Date = format(doy_to_date(target_year, prediction), "%b %d, %Y"),
    Interval = paste0(format(doy_to_date(target_year, lower), "%b %d"),
                      " – ", format(doy_to_date(target_year, upper), "%b %d")),
    Width = upper - lower
  ) |>
  select(City, DOY = prediction, Date, Interval, Width) |>
  arrange(DOY) |>
  kable(align = "lrlrr")
```

<br>

| Metric | Value |
|---|---:|
| Backtest MAE | **4.23 days** |
| R–Python agreement | `r round(avg_gap, 1)` days |
| SSW (tiebreaker) | `r ssw` |

:::
::: {.column width="45%"}

**Interpretation:**

- DC blooms earliest — Tidal Basin warmth
- Kyoto & Liestal cluster in late March
- NYC latest — continental cold delays spring
- All within 8-day spread across sites
- 90% intervals hold in backtest validation

:::
::::

---

## Enhanced vs Baseline {.smaller}

:::: {.columns}
::: {.column width="55%"}

```{r}
if (has_enh) {
  comp_tbl <- final_sub |>
    rename(base_pred = prediction, base_lo = lower, base_hi = upper) |>
    inner_join(enh_sub |> rename(enh_pred = prediction, enh_lo = lower, enh_hi = upper),
               by = "location") |>
    mutate(
      City = loc_names[location],
      `Baseline` = paste0("DOY ", base_pred, " (", base_hi - base_lo, "d)"),
      `Enhanced` = paste0("DOY ", enh_pred, " (", enh_hi - enh_lo, "d)"),
      `Shift` = paste0(ifelse(enh_pred > base_pred, "+", ""), enh_pred - base_pred, " d")
    ) |>
    select(City, Baseline, Enhanced, Shift)
  kable(comp_tbl, align = "llll")
} else {
  cat("Enhanced predictions not available")
}
```

<br>

**What adding temperature features does:**

- Directly models the winter → spring warming that triggers bloom
- Better calibration of spring warmth accumulation
- Tighter prediction intervals (avg 12.2 d vs 15.4 d baseline)

:::
::: {.column width="45%"}

```{r}
#| fig-width: 4.5
#| fig-height: 3.5
if (has_enh) {
  bind_rows(
    final_sub |> mutate(Model="Baseline", width=upper-lower),
    enh_sub |> mutate(Model="Enhanced", width=upper-lower)
  ) |>
    mutate(City = loc_names[location]) |>
    ggplot(aes(City, width, fill=Model)) +
    geom_col(position="dodge", alpha=0.8) +
    labs(title="Interval Width Comparison", y="Width (days)", x=NULL) +
    theme_minimal(base_size=10) +
    scale_fill_manual(values=c(Baseline="#F2A6B6", Enhanced="#8B2252")) +
    theme(axis.text.x = element_text(angle=30, hjust=1))
}
```

**25% lower MAE** (4.23 vs 5.61 days)

Vancouver remains widest (25 d) due to only 4 years of data.

:::
::::

---

## {.center}

<br><br>

### Team 5103 — University of Maryland

Cherry Blossom Peak Bloom Prediction 2026

<br>

[Interactive dashboard](dashboard.html) · [GitHub repo](https://github.com/GMU-CherryBlossomCompetition/peak-bloom-prediction)
